var evwait=false;function enterVerify(obj){var sk=$("#securitykey").val();if(sk.length>0){if(!evwait){$.ajax({beforeSend:function(){evwait=true;$.prompt.show('正在验证......')},complete:function(){evwait=false;$.prompt.hidden()},cache:false,data:{'obj':obj,'sk':sk},error:function(){$.dialog.showMsgLayer('系统异常','对不起，系统出现异常，请稍后再试！');},success:function(result){if("ok"==result){window.location.href=window.location.href;}else if("wait"==result){$.dialog.showMsgLayer('答案连续错误','答案连续输入错误，冷静会儿再试吧！');}else{$.dialog.showMsgLayer('答案错误','答案错了可不给看的哟！');}},type:'POST',url:'/albumsecurityverify.do'});}}else
$("#securitykey").focus();}
var reqwait=false;function reqAnswer(obj){if($.cookie('puid')){$.dialog.showFuncLayer(430,"确认索取",'索取答案将会以你的身份发送私信给相册用户，确认索取吗？',function(){if(!delwait){$.ajax({beforeSend:function(){delwait=true;$.prompt.show('操作进行中......')},complete:function(){delwait=false;$.prompt.hidden()},cache:false,data:{'obj':obj},error:function(){$.dialog.showMsgLayer('系统异常','对不起，系统出现异常，操作失败！');},success:function(result){if("unsignin"==result)
$.dialog.showMsgFuncLayer("登录失效","登录已失效，请重新登录！",function(){showSignIn();},1);else if("locked"==result)
$.dialog.showMsgLayer("账户锁定","你的账户被锁定了，不能完成操作！");else if("wait"==result)
$.dialog.showMsgLayer("等待回复","已发送，请等待用户回复！");else if("ok"==result)
$.dialog.showMsgLayer("操作成功","操作成功！请等待用户的回复。");else
$.dialog.showMsgLayer("操作失败","操作失败了！");},type:'POST',url:'/reqalbumanswer.do'});}});}else
$.dialog.showMsgFuncLayer("请登录","对不起，仅登录用户可进行此操作！",function(){showSignIn();});}
var iptless=function(exp,maxipt){var val=$(exp).val();if(val.length>maxipt){val=val.substr(0,maxipt);$(exp).val(val);}
$(exp).parent().find("label").first().html(val.length);}
var loadinfowait=false,loadalbumwait=false,creatalbumwait=false,delwait=false,editwait=false;var sug_tags='';$(".c_p_l_c_i_d .edit").live('click',function(){$.dialog.showIframeDialog(600,'移动/修改/删除图片','<div class="editphoto">'+'<div class="editphoto_t">移动图片到</div>'+'<div class="editphoto_a editphoto_ac">'+'<span class="editphoto_a_a">选择相册</span>'+'<span class="editphoto_a_d"><span class="editphoto_a_d_a">当前相册</span><span class="editphoto_a_d_b"></span><input type="hidden" name="album" value="-1" /></span>'+'</div>'+'<div class="editphoto_b"></div>'+'<div class="editphoto_t">修改图片信息</div>'+'<div class="editphoto_a">'+'<span class="editphoto_a_a">名称</span>'+'<span class="editphoto_a_b"><input type="text" name="name" maxlength="30" /><span><label>0</label><label class="editphoto_a_b_s">/</label>30</span></span>'+'<span class="editphoto_a_c">*</span>'+'</div>'+'<div class="editphoto_a">'+'<span class="editphoto_a_a">标签</span>'+'<span class="editphoto_a_b"><input type="text" name="tags" maxlength="30" /><span><label>0</label><label class="editphoto_a_b_s">/</label>30</span></span>'+'<span class="editphoto_a_c">*</span>'+'</div>'+'<div class="editphoto_a editphoto_ab">'+'<span class="editphoto_a_a">描述</span>'+'<span class="editphoto_a_b editphoto_a_bb"><textarea rows="2" cols="53" name="intro"></textarea><span><label>0</label><label class="editphoto_a_b_s">/</label>150</span></span>'+'</div>'+'<div class="editphoto_c"><input type="button" value="删除此图片" /></div>'+'<div class="editphoto_d"><input type="button" value="确定" class="editphoto_d_a cbtn" /><input type="button" value="取消" class="cbtn" /></div>'+'</div>');var pfi=$(this).parents('.c_p_l_c_i');var obj=pfi.attr('data-obj');var edit=$(".editphoto");if(edit.length){if(!loadinfowait){$.ajax({beforeSend:function(){loadinfowait=true;$.prompt.show('正在加载图片信息......');},complete:function(){loadinfowait=false;},cache:false,data:{'obj':obj},dataType:"json",error:function(){$.prompt.show('加载图片信息失败！');setTimeout(function(){$.prompt.hidden();},3000);},success:function(result){if(result){$.prompt.hidden();edit.find(".editphoto_a_d_a").html(result.albumname);edit.find(".editphoto_a_b :text[name=name]").val(result.name);edit.find(".editphoto_a_b :text[name=tags]").val(result.tags);edit.find(".editphoto_a_bb textarea").val(result.intro);iptless(".editphoto_a_b :text[name=name]",30);iptless(".editphoto_a_b :text[name=tags]",30);iptless(".editphoto_a_bb textarea",150);}else{$.prompt.show('加载图片信息失败！');setTimeout(function(){$.prompt.hidden();},3000);}},url:'/loadphotoinfo.do'});}
edit.find(".editphoto_a_d").hover(function(){$(this).css("border-color","#0c0");edit.find(".editphoto_a_d_b").css("background-position","-105px -110px");},function(){if(!edit.find('.editphoto_ac .editphoto_a_e:visible').length){$(this).css("border-color","#ccc");edit.find(".editphoto_a_d_b").css("background-position","0 -110px");}}).click(function(){var ealo=edit.find('.editphoto_ac .editphoto_a_e');if(ealo.length)
ealo.toggle();else{if(!loadalbumwait){$.ajax({beforeSend:function(){loadalbumwait=true;$.prompt.show('正在加载相册列表......');},complete:function(){loadalbumwait=false;},cache:false,dataType:"json",error:function(){$.prompt.show('加载相册列表失败！');setTimeout(function(){$.prompt.hidden();},3000);},success:function(result){if(result&&result.album&&$.isArray(result.album)){$.prompt.hidden();var al='';al+='<span class="editphoto_a_e">';if(result.album.length){al+='<span class="editphoto_a_e_a">';$.each(result.album,function(i,v){al+='<label data-obj="'+ v.obj+'">'+ v.name+'（'+ v.num+'）</label>';});al+='</span>';}
al+='<span class="editphoto_a_e_b">';al+='<span class="editphoto_a_b editphoto_a_e_b_a">';al+='<input type="text" name="newalbum" maxlength="20" />';al+='<span><label>0</label><label class="editphoto_a_b_s">/</label>20</span>';al+='</span>';al+='<input type="button" value="创建相册" class="cbtn editphoto_a_e_b_b" />';al+='</span>';al+='</span>';edit.find('.editphoto_ac').append(al);edit.find('.editphoto_a_e_a label').click(function(){edit.find('.editphoto_a_d_a').html($(this).html().replace(/（\d+）$/g,''));edit.find(':hidden[name=album]').val($(this).attr("data-obj"));$(document).click();});edit.find('.editphoto_a_e_b_a :text[name=newalbum]').keyup(function(){iptless(this,20);});edit.find(':button.editphoto_a_e_b_b').click(function(){var newalbum=edit.find('.editphoto_a_e_b_a :text[name=newalbum]').val();if(!newalbum.length)
$.alert.show("请输入相册名称！");else{if(!creatalbumwait){$.ajax({beforeSend:function(){creatalbumwait=true;$.prompt.show('正在创建相册......')},complete:function(){creatalbumwait=false;$.prompt.hidden()},cache:false,data:{"name":newalbum},error:function(){$.alert.show('对不起，系统出现异常，相册创建失败！');},success:function(result){if("mgc"==result){$.alert.show("相册名称中包含敏感词，请修改！");}else if(result=="had"){$.alert.show('已存在同名相册，请更改名称！');}else if(result=='ok'){$.alert.show("创建成功",function(){window.location.reload();});}else if(result=="unsignin")
$.alert.show("登录已失效，请重新登录！",function(){showSignIn();});else if(result=="ulock")
$.alert.show('你的账户被锁定了，不能完成操作！');else{$.alert.show('相册创建失败！');}},type:'POST',url:'/?m=Home&c=User&a=creat_album_ajax'});}}});}else{$.prompt.show('加载相册列表失败！');setTimeout(function(){$.prompt.hidden();},3000);}},url:'/loaduseralbum.do'});}}
return false;});$(".editphoto_ac").click(function(){return false;});$(document).click(function(){var ealo=edit.find('.editphoto_ac .editphoto_a_e');if(ealo.length){ealo.hide();edit.find(".editphoto_a_d").css("border-color","#ccc");edit.find(".editphoto_a_d_b").css("background-position","0 -110px");}});edit.find(".editphoto_a_b :text").keyup(function(){iptless(this,30);});edit.find(".editphoto_a_b :text[name=tags]").focus(function(){var nthis=$(this);if(sug_tags.length)
showsugtags(nthis);else{$.getJSON("/suggesttags.do?v="+ Math.random(),function(rs){if(rs){sug_tags=rs.tags;showsugtags(nthis);}});}});edit.find(".editphoto_a_b :text[name=tags]").click(function(){return false;});var showsugtags=function(nthis){$.tips.show(nthis.parent(),{top:30,left:-1},sug_tags);edit.find(".us_tags a").click(function(){if($(this).hasClass("current")){$(this).removeClass("current");nthis.val($.trim(nthis.val().replace(new RegExp($(this).html(),"g"),'').replace(/(\s)\s/g,'$1')));}else{var nval=$.trim(nthis.val()+' '+ $(this).html());if(nval.length<30){$(this).addClass("current");nthis.val(nval);}}
iptless(".editphoto_a_b :text[name=tags]",30);return false;});$.each(nthis.val().split(' '),function(i,v){if($.trim(v).length){edit.find(".us_tags a:contains('"+ v.replace(/'/g,"\\'").replace(/"/g,"\\'")+"')").each(function(x,o){if($(o).html()==v)
$(o).addClass("current");});}});};$(document).click(function(){$.tips.hidden(edit.find(".editphoto_a_b :text[name=tags]").parent());});edit.find(".editphoto_a_bb textarea").keyup(function(e){iptless(this,150);});edit.find(".editphoto_c :button").click(function(){$.alert.show('确定要删除此图片吗？',function(){if(!delwait){$.ajax({beforeSend:function(){delwait=true;$.prompt.show('正在删除......')},complete:function(){delwait=false;$.prompt.hidden()},cache:false,data:{'obj':obj},error:function(){$.alert.show('对不起，系统出现异常，删除失败！');},success:function(result){if("unsignin"==result){$.alert.show("登录已失效，请重新登录！",function(){showSignIn();});}else if("ok"==result){if(/\/photo\/(\w+)\.html/i.test(window.location.href)){if(typeof onext!="undefined"&&obj!=onext)
window.location.href="/"+ getUserFromPath()+'/photo/'+ onext+'.html';else
window.location.href='/';}else{pfi.hide();$.alert.hidden();$.dialog.hidden();}}else{$.alert.show("删除失败了！");}},type:'POST',url:'/delphoto.do'});}},1);});edit.find(".editphoto_d :button:eq(0)").click(function(){var name=$(".editphoto_a_b :text[name='name']").val();var tags=$(".editphoto_a_b :text[name='tags']").val();if(!name.length)
$.alert.show("请输入图片名称！");else if(!tags.length)
$.alert.show("请输入图片标签！");else{if(!editwait){$.ajax({beforeSend:function(){editwait=true;$.prompt.show('正在提交编辑信息......')},complete:function(){editwait=false;$.prompt.hidden()},cache:false,data:{"obj":obj,"album":edit.find(':hidden[name=album]').val(),"name":name,"tags":tags,"intro":edit.find(".editphoto_a_bb textarea").val()},error:function(){$.alert.show('对不起，系统出现异常，图片信息编辑失败！');},success:function(result){if("nmgc"==result)
$.alert.show("名称中包含敏感词，请修改！");else if("tmgc"==result)
$.alert.show("标签中包含敏感词，请修改！");else if("imgc"==result)
$.alert.show("描述中包含敏感词，请修改！");else{if(result=="ok")
window.location.href=window.location.href;else if(result=="unsignin")
$.alert.show("登录已失效，请重新登录！",function(){showSignIn();},1);else if(result=="ulock")
$.alert.show('你的账户被锁定了，不能完成操作！');else
$.alert.show('图片信息编辑失败了！');}},type:'POST',url:'/editphotoinfo.do'});}}});edit.find(".editphoto_d :button:eq(1)").click(function(){$.dialog.hidden();});}});